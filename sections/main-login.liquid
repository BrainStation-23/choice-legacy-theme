<style>
  .login-container {
    width: 100%;
    display: flex;
    justify-content: center;
    padding-top: 48px ;
    padding-bottom: 88px;
  }

  .login-container .form-input-field .form-input {
    height: 54px;
  }

  .h-captcha {
    display: none;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    min-width: 406px;
  }

  .login-header {
    text-align: center;
    display: flex;
    flex-direction: column;
  }

  .login-title {
    text-transform: uppercase;
  }

  .login-subtitle {
    display: flex;
    align-items: center;
    flex-direction: row;
    justify-content: center;
  }

  .login-subtitle a {
    color: rgb(var(--color-primary-brand));
    text-decoration: none;
  }

  .password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 4px;
    font-size: 18px;
  }

  .forgot-password {
    color: rgb(var(--color-primary-brand));
    text-decoration: none;
  }

  .login-button {
    width: 100%;
    background: rgb(var(--color-primary-brand));
    color: rgb(var(--color-background));
    border: none;
    padding: 14px;
    border-radius: 6px;
    cursor: pointer;
  }

  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
  }

  .alert-error {
    background-color: #fee;
    color: #c33;
    border: 1px solid #fcc;
  }

  .alert-success {
    background-color: #efe;
    color: #363;
    border: 1px solid #cfc;
  }

  .hidden {
    display: none !important;
  }

  .login-form-container {
    display: flex;
    flex-direction: column;
  }

  .login-form-container form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
</style>

<div class="login-container">
  <!-- LOGIN FORM -->
  <div id="login" class="login-form gap-32">
    <div class="login-header gap-8">
      <h1 class="login-title ff-bebas-neue fs-36-lh-40-ls-0 fw-400">{{ 'customer.login.title' | t }}</h1>
      <div class="login-subtitle gap-12">
        <h2 class="login-new__customer ff-general-sans fs-16-lh-22-ls-0 fw-600">
          {{ 'customer.login.new_customer' | t }}
        </h2>
        <a href="{{ routes.account_register_url }}" class="ff-general-sans fs-14-lh-100pct-ls-0 fw-600">
          {{ 'customer.login.create_account' | t -}}
        </a>
      </div>
    </div>
    <div class="login-form-container gap-16">
      {%- form 'customer_login', novalidate: 'novalidate', class: 'login-submit-form' -%}
        {%- if form.errors -%}
          <div class="alert alert-error" tabindex="-1" autofocus>
            {{ form.errors | default_errors }}
          </div>
        {%- endif -%}

        <!-- Hidden Email Field -->
        <div class="form-field hidden">
          <input
            type="email"
            class="form-input"
            id="customer-email"
            name="customer[email]"
            autocomplete="email"
            {%- if form.errors contains 'form' %}
              aria-invalid="true"
            {%- endif %}
            aria-required="true"
            required
          >
        </div>
        {%- assign phoneLabel = 'customer.login.phone' | t -%}
        {%- assign placeholder = 'customer.login.phone' | t -%}

        {%
          render 'input',
          type: 'number',
          id: 'customer-phone',
          name: 'customer[phone]',
          label: phoneLabel,
          placeholder: placeholder,
          autocomplete: 'tel',
          required: true,
          class: 'login-input-phone-field',
          invalid: form.errors contains 'form'
        %}

        <!-- Password Field -->
        {%- if form.password_needed -%}
          {%- assign passwordLabel = 'customer.login.password' | t -%}
          {%- assign passwordPlaceholder = 'customer.login.password' | t -%}

          {%
            render 'input',
            type: 'password',
            id: 'customer-password',
            name: 'customer[password]',
            label: passwordLabel,
            placeholder: passwordPlaceholder,
            required: true,
            class: 'login-input-password-field',
            invalid: form.errors contains 'form'
          %}
        {%- endif -%}
        <div class="form-forgot-password">
          <a class="forgot-password js-recover fs-14-lh-100pct-ls-0 fw-600 ff-general-sans" href="#recover">
            {{ 'customer.login.forgot_password' | t }}
          </a>
        </div>
      {%- endform -%}

      <!-- External Login Button -->
      <button id="login-submit-button-external" class="login-button  ff-general-sans fs-14-lh-100pct-ls-0 fw-600">
        {{ 'customer.login.sign_in' | t }}
      </button>
    </div>
  </div>

  <!-- Forgot Password Section (Initially Hidden) -->
  <div id="forgot-password-section" class="hidden">
    {% render 'forgot-password' %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const passwordToggles = document.querySelectorAll('.toggle-password');

    passwordToggles.forEach((toggle) => {
      toggle.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        const openEye = passwordInput.parentElement.querySelector('.password-toggle-eye-open');
        const closeEye = passwordInput.parentElement.querySelector('.password-toggle-eye-close');

        if (passwordInput.type === 'password') {
          // Show password
          passwordInput.type = 'text';
          openEye.style.display = 'none';
          closeEye.style.display = 'flex';
        } else {
          // Hide password
          passwordInput.type = 'password';
          closeEye.style.display = 'none';
          openEye.style.display = 'flex';
        }
      });
    });

    const loginForm = document.getElementById('login');
    const forgotPasswordSection = document.getElementById('forgot-password-section');
    const phoneInput = document.getElementById('customer-phone');
    const emailInput = document.getElementById('customer-email');
    const loginButtonExternal = document.getElementById('login-submit-button-external');
    const loginSubmitForm = document.querySelector('.login-submit-form');

    const API_BASE_URL = `/apps/${APP_SUB_PATH}/customer/account`;

    // Toggle between login and forgot password
    function toggleForms(showForgotPassword) {
      if (showForgotPassword) {
        loginForm.classList.add('hidden');
        forgotPasswordSection.classList.remove('hidden');
      } else {
        loginForm.classList.remove('hidden');
        forgotPasswordSection.classList.add('hidden');
      }
    }

    // Handle forgot password link click
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('js-recover')) {
        e.preventDefault();
        toggleForms(true);
        history.pushState('', document.title, `${window.location.pathname}#recover`);
      }
    });

    // Handle back to login (this will work with the forgot password form's back link)
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('js-login')) {
        e.preventDefault();
        toggleForms(false);
        history.pushState('', document.title, window.location.pathname);
      }
    });

    // Check URL hash on page load
    if (window.location.hash === '#recover') {
      toggleForms(true);
    }

    // External Login
    if (loginButtonExternal) {
      loginButtonExternal.addEventListener('click', async () => {
        const phone = phoneInput ? phoneInput.value.trim() : '';
        try {
          const response = await fetch(`${API_BASE_URL}/login/+88${phone}`);
          const data = await response.json();

          if (!response.ok) {
            alert('Login failed: ' + (data.message || 'Unknown error'));
            throw new Error(data.message || 'Login failed');
          }

          if (data.email) {
            emailInput.value = data.email;
            loginSubmitForm.submit();
          }
        } catch (error) {
          console.error('Error:', error);
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Login",
  "class": "cc-main-login section section--template",
  "settings": [
    {
      "type": "header",
      "content": "Sign in with Shop settings"
    },
    {
      "type": "checkbox",
      "id": "enable_shop_login_button",
      "label": "Enable Sign in with Shop",
      "default": false
    }
  ]
}
{% endschema %}
