{{ 'home-page-review.css' | asset_url | stylesheet_tag }}

<style>
  .homepage-product-review__section-{{ section.id }} {
    background-color: rgb(var(--color-secondary-brand));
    padding-top: 88px;
    padding-bottom: 88px;
  }

  .homepage-product-review__section-{{ section.id }} .custom-pagination {
    background: rgb(var(--color-background));
  }

  /* Load More Button Styles */
  .homepage-product-review__load-more {
    display: flex;
    justify-content: center;
    margin-top: 32px;
  }

  .homepage-product-review__load-more-btn {
    background: rgb(var(--color-background));
    color: rgb(var(--color-foreground));
    border: 2px solid rgb(var(--color-foreground));
    padding: 12px 24px;
    font-family: var(--font-bebas-neue);
    font-size: 18px;
    font-weight: 400;
    letter-spacing: 0.6px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    position: relative;
    min-width: 180px;
  }

  .homepage-product-review__load-more-btn:hover:not(:disabled) {
    background: rgb(var(--color-foreground));
    color: rgb(var(--color-background));
  }

  .homepage-product-review__load-more-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .homepage-product-review__load-more-btn.loading {
    color: transparent;
  }

  .homepage-product-review__load-more-btn.loading::after {
    content: "";
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid rgb(var(--color-foreground));
    border-radius: 50%;
    border-top-color: transparent;
    animation: button-loading-spinner 1s ease infinite;
  }

  @keyframes button-loading-spinner {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .homepage-product-review__load-more.hidden {
    display: none;
  }

  /* Desktop: Show grid, hide swiper */
  @media (min-width: 769px) {
    .homepage-product-review__desktop-only {
      display: block;
    }
    .homepage-product-review__mobile-tablet-only {
      display: none;
    }
  }

  /* Tablet and Mobile: Hide grid, show swiper */
  @media (max-width: 768px) {
    .homepage-product-review__section-{{ section.id }} {
      padding-top: 24px;
      padding-bottom: 24px;
    }
    .homepage-product-review__desktop-only {
      display: none;
    }
    .homepage-product-review__mobile-tablet-only {
      display: block;
    }

    .homepage-product-review__mobile-tablet-only .swiper-container {
      position: relative;
      padding-bottom: 20px;
    }
    .swiper-slide:last-child {
      margin-right: 0;
    }
    .homepage-product-review__mobile-tablet-only .swiper-container .swiper-wrapper {
      gap: 16px !important;
    }

    /* Product review carousel mode styles */
    .swiper-container[data-carousel-mode="true"] .homepage-product-review__card {
      width: var(--slide-width-mobile, 220px);
      flex-shrink: 0;
    }
    .homepage-product-review__card {
      text-align: left;
    }

    .homepage-product-review__load-more-btn {
      font-size: 16px;
      padding: 10px 20px;
    }
  }
</style>

<section class="homepage-product-review__section homepage-product-review__section-{{ section.id }}">
  <div class="homepage-product-review__container page-width gap-48">
    {% if section.settings.title != blank %}
      <h2 class="homepage-product-review__title ff-bebas-neue ft-400 fs-36-lh-40-ls-0 mobile-fs-21-lh-24-ls-1_2pct">
        {{ section.settings.title }}
      </h2>
    {% endif %}

    <!-- Desktop Grid Content -->
    <div id="homepage-product-review__desktop-content" class="homepage-product-review__desktop-only">
      <div class="homepage-product-review__loading">
        <div class="homepage-product-review__spinner"></div>
      </div>
    </div>

    <!-- Load More Button for Desktop -->
    <div
      id="homepage-product-review__load-more-desktop"
      class="homepage-product-review__load-more homepage-product-review__desktop-only hidden"
    >
      <button id="load-more-btn-desktop" class="homepage-product-review__load-more-btn" onclick="loadMoreReviews()">
        Load More Reviews
      </button>
    </div>

    <!-- Mobile/Tablet Slideshow Content -->
    <div id="homepage-product-review__mobile-content" class="homepage-product-review__mobile-tablet-only">
      <slideshow-component
        data-autoplay="false"
        data-show-progress-bar="true"
        data-slides-per-view-desktop="3"
        data-slides-per-view-tablet="2"
        data-slides-per-view-mobile="2"
        data-single-slide-view="true"
        data-carousel-mode="true"
        data-slide-width-mobile="284px"
        data-slide-width-tablet="284px"
        data-slide-width-desktop="284px"
      >
        <div class="swiper-container flex flex-col gap-16">
          <div class="swiper-wrapper" id="mobile-slides-container">
            <div class="homepage-product-review__loading">
              <div class="homepage-product-review__spinner"></div>
            </div>
          </div>
          {% render 'slideshow-progress-bar' %}
        </div>
      </slideshow-component>
    </div>

    <!-- Load More Button for Mobile/Tablet -->
    <div
      id="homepage-product-review__load-more-mobile"
      class="homepage-product-review__load-more homepage-product-review__mobile-tablet-only hidden"
    >
      <button id="load-more-btn-mobile" class="homepage-product-review__load-more-btn" onclick="loadMoreReviews()">
        Load More Reviews
      </button>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const desktopContent = document.getElementById('homepage-product-review__desktop-content');
    const mobileSlidesContainer = document.getElementById('mobile-slides-container');
    const loadMoreDesktop = document.getElementById('homepage-product-review__load-more-desktop');
    const loadMoreMobile = document.getElementById('homepage-product-review__load-more-mobile');
    const loadMoreBtnDesktop = document.getElementById('load-more-btn-desktop');
    const loadMoreBtnMobile = document.getElementById('load-more-btn-mobile');

    let allReviews = [];
    let displayedReviews = [];
    let currentPage = 0;
    const initialLoad = 8;
    const loadMoreCount = 4;

    const allProducts = {
      {% for product in collections.all.products limit: 250 %}
        "{{ product.id }}": {
          "title": "{{ product.title | escape }}",
          "handle": "{{ product.handle }}"
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    };

    function createStarRating(rating) {
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
          starsHtml += '<span class="homepage-product-review__star">★</span>';
        } else {
          starsHtml += '<span class="homepage-product-review__star homepage-product-review__star--empty">★</span>';
        }
      }
      return starsHtml;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function getProductTitle(productId) {
      const product = allProducts[productId];
      return product ? product.title : 'Title is not available';
    }

    function createReviewCard(review) {
      const productTitle = getProductTitle(review.productId);
      const imageHtml = review.reviewImage
        ? `<img src="${review.reviewImage}" alt="${productTitle}" class="homepage-product-review__image" loading="lazy">`
        : `<div class="homepage-product-review__image" style="background: linear-gradient(45deg, #f0f0f0, #e0e0e0); display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.8rem;">No Image</div>`;

      return {
        desktop: `
          <div class="homepage-product-review__card gap-16 box-shadow">
            <div class="homepage-product-review__image-container homepage-product-review__content-top">
              ${imageHtml}
              <div class="homepage-product-review__rating box-shadow gap-4">
                ${createStarRating(review.rating)}
              </div>
            </div>
            <div class="homepage-product-review__content-middle gap-8">
              <div class="homepage-product-review__product-title fs-21-lh-24-ls-1_2pct ff-bebas-neue fw-400">
                ${productTitle}
              </div>
              <div class="homepage-product-review__text ff-general-sans fs-14-lh-20-ls-0 fw-400">
                ${review.reviewText}
              </div>
            </div>
            <div class="homepage-product-review__content-bottom gap-4">
              <span class="homepage-product-review__review-date fs-12-lh-16-ls-0_6pct ff-general-sans fw-400">
                ${formatDate(review.reviewPlacedAt)}
              </span>
              <span class="homepage-product-review__customer-name fs-12-lh-16-ls-0_6pct ff-general-sans fw-400">
                By ${review.customerName}
              </span>
            </div>
          </div>
        `,
        mobile: `
          <div class="swiper-slide">
            <div class="homepage-product-review__card-items homepage-product-review__card gap-16 box-shadow" style="width: 284px;">
              <div class="homepage-product-review__image-container homepage-product-review__content-top">
                ${imageHtml}
                <div class="homepage-product-review__rating box-shadow gap-4">
                  ${createStarRating(review.rating)}
                </div>
              </div>
              <div class="homepage-product-review__content-middle gap-8">
                <div class="homepage-product-review__product-title fs-21-lh-24-ls-1_2pct ff-bebas-neue fw-400">
                  ${productTitle}
                </div>
                <div class="homepage-product-review__text ff-general-sans fs-14-lh-20-ls-0 fw-400">
                  ${review.reviewText}
                </div>
              </div>
              <div class="homepage-product-review__content-bottom gap-4">
                <span class="homepage-product-review__review-date fs-12-lh-16-ls-0_6 ff-general-sans fw-400">
                  ${formatDate(review.reviewPlacedAt)}
                </span>
                <span class="homepage-product-review__customer-name fs-12-lh-16-ls-0_6 ff-general-sans fw-400">
                  By ${review.customerName}
                </span>
              </div>
            </div>
          </div>
        `
      };
    }

    function updateLoadMoreButton() {
      const hasMoreReviews = displayedReviews.length < allReviews.length;
      
      if (hasMoreReviews) {
        loadMoreDesktop.classList.remove('hidden');
        loadMoreMobile.classList.remove('hidden');
      } else {
        loadMoreDesktop.classList.add('hidden');
        loadMoreMobile.classList.add('hidden');
      }
    }

    function setLoadingState(isLoading) {
      if (isLoading) {
        loadMoreBtnDesktop.disabled = true;
        loadMoreBtnMobile.disabled = true;
        loadMoreBtnDesktop.classList.add('loading');
        loadMoreBtnMobile.classList.add('loading');
      } else {
        loadMoreBtnDesktop.disabled = false;
        loadMoreBtnMobile.disabled = false;
        loadMoreBtnDesktop.classList.remove('loading');
        loadMoreBtnMobile.classList.remove('loading');
      }
    }

    function renderReviews(newReviews = []) {
      if (newReviews.length > 0) {
        displayedReviews = [...displayedReviews, ...newReviews];
      }

      // Generate desktop grid content
      const desktopReviewsHtml = displayedReviews.map(review => createReviewCard(review).desktop).join('');
      
      // Generate mobile slideshow content
      const mobileSlidesHtml = displayedReviews.map(review => createReviewCard(review).mobile).join('');

      // Update desktop content
      const existingGrid = desktopContent.querySelector('.homepage-product-review__grid');
      if (existingGrid) {
        if (newReviews.length > 0) {
          // Append new reviews
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = newReviews.map(review => createReviewCard(review).desktop).join('');
          
          const newCards = tempDiv.children;
          Array.from(newCards).forEach((card) => {
            existingGrid.appendChild(card);
          });
        }
      } else {
        desktopContent.innerHTML = `<div class="homepage-product-review__grid gap-16">${desktopReviewsHtml}</div>`;
      }

      // Update mobile slideshow content
      mobileSlidesContainer.innerHTML = mobileSlidesHtml;

      // Reinitialize slideshow component after content update
      const slideshowComponent = document.querySelector('slideshow-component');
      if (slideshowComponent) {
        // Destroy existing swiper instance
        if (slideshowComponent.swiper) {
          slideshowComponent.swiper.destroy(true, true);
          slideshowComponent.swiper = null;
        }
        
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          // Reinitialize the slideshow component
          slideshowComponent.initializeSwiper();
          
          // Update custom bullets if they exist
          if (typeof slideshowComponent.initializeCustomBullets === 'function') {
            slideshowComponent.initializeCustomBullets();
          }
        }, 100);
      }

      updateLoadMoreButton();
    }

    async function fetchReviews() {
      try {
        const response = await fetch(`/apps/generic-name/customer/product-review/show-home`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        if (data.success && data.data && data.data.length > 0) {
          allReviews = data.data;
          currentPage = 0;
          displayedReviews = [];
          
          // Load initial reviews
          const initialReviews = allReviews.slice(0, initialLoad);
          renderReviews(initialReviews);
        } else {
          displayNoReviews();
        }
      } catch (error) {
        console.error('Error fetching reviews:', error);
        displayError();
      }
    }

    // Global function for load more button
    window.loadMoreReviews = function() {
      const startIndex = displayedReviews.length;
      const endIndex = Math.min(startIndex + loadMoreCount, allReviews.length);
      const newReviews = allReviews.slice(startIndex, endIndex);
      
      if (newReviews.length > 0) {
        setLoadingState(true);
        
        // Simulate network delay for loading state (remove this in production if not needed)
        setTimeout(() => {
          renderReviews(newReviews);
          setLoadingState(false);
        }, 300);
      }
    }

    function displayNoReviews() {
      const noReviewsHtml = '<div class="homepage-product-review__empty fs-36-lh-40-ls-0pct fw-500">No reviews available at the moment.</div>';
      desktopContent.innerHTML = noReviewsHtml;
      mobileSlidesContainer.innerHTML = `<div class="swiper-slide">${noReviewsHtml}</div>`;
      loadMoreDesktop.classList.add('hidden');
      loadMoreMobile.classList.add('hidden');
    }

    function displayError() {
      const errorHtml = '<div class="homepage-product-review__error fs-36-lh-40-ls-0pct fw-500">Unable to load reviews. Please try again later.</div>';
      desktopContent.innerHTML = errorHtml;
      mobileSlidesContainer.innerHTML = `<div class="swiper-slide">${errorHtml}</div>`;
      loadMoreDesktop.classList.add('hidden');
      loadMoreMobile.classList.add('hidden');
    }

    fetchReviews();
    
    document.addEventListener("shopify:section:load", (event) => {
      if (event.target.classList.contains("homepage-product-review__section")) {
        fetchReviews();
      }
    });

    document.addEventListener("shopify:section:select", (event) => {
      if (event.target.classList.contains("homepage-product-review__section")) {
        fetchReviews();
      }
    });

 });
</script>

{% schema %}
{
  "name": "Product Reviews",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "SEE WHAT OUR CUSTOMERS ARE SAYING"
    },
    {
      "type": "header",
      "content": "Mobile & Tablet Slideshow Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay (Mobile & Tablet only)",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Product Reviews"
    }
  ]
}
{% endschema %}
