<style>
  .h-captcha {
    display: none;
  }

  .response-message {
    display: none;
  }

  .response-message.show {
    display: flex;
    align-items: center;
  }
</style>

<div class="w-full flex justify-center pt-48 pb-88 sm:pt-16 sm:pb-16 page-width">
  <div id="register" class=" flex flex-col  gap-32  max-w-406">
    <div class="flex flex-col gap-8 text-center">
      <h1 class=" ff-bebas-neue fs-36-lh-40-ls-0 fw-400 uppercase">
        {{ 'customer.register.title' | t }}
      </h1>
    </div>

    <div class=" flex flex-col gap-16">
      {%- form 'create_customer', class: 'register-submit-form flex flex-col gap-16', novalidate: 'novalidate' -%}
        {%- if form.errors -%}
          <div class="alert alert-error" tabindex="-1" autofocus>
            <h2>{{ 'customer.register.error_heading' | t }}</h2>
            <ul>
              {%- for field in form.errors -%}
                <li>
                  {%- if field == 'form' -%}
                    {{ form.errors.messages[field] }}
                  {%- else -%}
                    {{ form.errors.translated_fields[field] | capitalize }}
                    {{ form.errors.messages[field] }}
                  {%- endif -%}
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
        <div class="flex gap-16 sm:flex-col">
          {%- assign firstNameLabel = 'customer.register.first_name' | t -%}
          {%- assign firstNamePlaceholder = 'customer.register.first_name' | t -%}
          {%
            render 'input',
            type: 'text',
            id: 'customer-first-name',
            name: 'customer[first_name]',
            label: firstNameLabel,
            placeholder: firstNamePlaceholder,
            autocomplete: 'given-name',
            required: true,
            class: '',
            invalid: form.errors contains 'first_name',
            value: form.first_name
          %}

          <!-- Last Name -->
          {%- assign lastNameLabel = 'customer.register.last_name' | t -%}
          {%- assign lastNamePlaceholder = 'customer.register.last_name' | t -%}
          {%
            render 'input',
            type: 'text',
            id: 'customer-last-name',
            name: 'customer[last_name]',
            label: lastNameLabel,
            placeholder: lastNamePlaceholder,
            autocomplete: 'family-name',
            required: true,
            class: '',
            invalid: form.errors contains 'last_name',
            value: form.last_name
          %}
        </div>
        <!-- First Name -->

        <!-- Phone Number -->
        <div class=" flex gap-16">
          {% assign phoneLabel = 'customer.register.phone' | t -%}
          {% assign phonePlaceholder = 'customer.register.phone_placeholder' | t -%}
          <div class="phone-input-wrapper gap-16 flex-1 ">
            {%
              render 'input',
              type: 'tel',
              id: 'customer-phone',
              name: 'customer[phone]',
              label: phoneLabel,
              placeholder: phonePlaceholder,
              autocomplete: 'tel',
              required: true,
              class: '',
              invalid: form.errors contains 'phone',
              value: form.phone
            %}
          </div>
          <button
            type="button"
            id="send-otp-button"
            class="button--solid  border-none rounded-6 cursor-pointer  ff-general-sans fs-14-lh-100pct-ls-0 fw-600"
          >
            {{ 'customer.register.send_otp' | t }}
          </button>
        </div>

        {% render 'otp-input' %}

        <!-- Email -->
        {%- assign emailLabel = 'customer.register.email' | t -%}
        {%- assign emailPlaceholder = 'example@gmail.com' -%}
        {%
          render 'input',
          type: 'email',
          id: 'customer-email',
          name: 'customer[email]',
          label: emailLabel,
          placeholder: emailPlaceholder,
          autocomplete: 'email',
          required: false,
          class: '',
          invalid: form.errors contains 'email',
          value: form.email
        %}

        <!-- Password -->
        {%- assign passwordLabel = 'customer.register.password' | t -%}
        {%- assign passwordPlaceholder = 'customer.register.password' | t -%}
        {%
          render 'input',
          type: 'password',
          id: 'customer-password',
          name: 'customer[password]',
          label: passwordLabel,
          placeholder: passwordPlaceholder,
          autocomplete: 'new-password',
          required: true,
          class: '',
          invalid: form.errors contains 'password'
        %}

        <!-- Confirm Password -->
        {% render 'input',
          type: 'password',
          id: 'customer-confirm-password',
          name: 'customer[password_confirmation]',
          label: 'Confirm Password',
          placeholder: 'Confirm Password',
          autocomplete: 'new-password',
          required: true,
          class: ''
        %}
      {%- endform -%}

      <!-- External Register Button -->
      <button
        id="register-submit-button-external"
        class=" button--solid  border-none rounded-6 cursor-pointer  ff-general-sans fs-14-lh-100pct-ls-0 fw-600 pt-18 pb-18 pl-10 pr-10"
      >
        {{ 'customer.register.submit' | t }}
      </button>

      <!-- Response Message -->
      <div
        id="response-message"
        class="response-message pt-12 pb-16 rounded-8 mt-16 fs-14-lh-20-ls-0_1 ff-general-sans fw-600 text-center"
      ></div>

      <div class="text-brand text-center">
        <a
          href="{{ routes.account_login_url }} "
          class="ff-general-sans fs-14-lh-100pct-ls-0 fw-600 text-brand no-underline"
          aria-label="{{ 'customer.register.log_in' | t  }}"
        >
          {{ 'customer.register.log_in' | t }}
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Password toggles
    const passwordToggles = document.querySelectorAll('.toggle-password');

    passwordToggles.forEach((toggle) => {
      toggle.addEventListener('click', function () {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        const openEye = passwordInput.parentElement.querySelector('.password-toggle-eye-open');
        const closeEye = passwordInput.parentElement.querySelector('.password-toggle-eye-close');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          if (openEye) openEye.style.display = 'none';
          if (closeEye) closeEye.style.display = 'flex';
        } else {
          passwordInput.type = 'password';
          if (closeEye) closeEye.style.display = 'none';
          if (openEye) openEye.style.display = 'flex';
        }
      });
    });

    // Form elements
    const firstNameInput = document.getElementById('customer-first-name');
    const lastNameInput = document.getElementById('customer-last-name');
    const phoneInput = document.getElementById('customer-phone');
    const emailInput = document.getElementById('customer-email');
    const passwordInput = document.getElementById('customer-password');
    const confirmPasswordInput = document.getElementById('customer-confirm-password');
    const sendOtpButton = document.getElementById('send-otp-button');
    const otpContainer = document.getElementById('otp-container');
    const otpMessage = document.getElementById('otp-message');
    const registerButton = document.getElementById('register-submit-button-external');
    const registerForm = document.querySelector('.register-submit-form');
    const otpDigits = document.querySelectorAll('.otp-digit');
    const otpHiddenInput = document.getElementById('customer-otp-hidden');
    const responseMessage = document.getElementById('response-message');

    const API_BASE_URL = `/apps/${APP_SUB_PATH}/customer/account`;

    let isOtpSent = false;

    // Phone validation - now accepts both formats
    function validatePhoneNumber(phone) {
      if (!phone || phone.trim() === '') return false;
      let cleanedPhone = phone.replace(/[\s-]/g, '');

      if (cleanedPhone.startsWith('+88')) {
        cleanedPhone = cleanedPhone.substring(3);
      }

      return /^01\d{9}$/.test(cleanedPhone);
    }

    function cleanPhoneNumber(phone) {
      if (!phone || phone.trim() === '') return '';
      let cleanedPhone = phone.replace(/[\s-]/g, '');
      if (cleanedPhone.startsWith('+88')) {
        return cleanedPhone;
      }
      return '+88' + cleanedPhone;
    }

    function showResponseMessage(message, type) {
      responseMessage.textContent = message;
      responseMessage.className = `response-message ${type} show`;
      if (type === 'success-text') {
        setTimeout(() => {
          responseMessage.classList.remove('show');
        }, 5000);
      }
    }

    function hideResponseMessage() {
      responseMessage.classList.remove('show');
    }

    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `otp-message ${type}`;
    }

    // OTP Input Handling
    function setupOtpInputs() {
      otpDigits.forEach((input, index) => {
        input.addEventListener('input', function (e) {
          const value = e.target.value;
          if (!/^\d*$/.test(value)) {
            e.target.value = '';
            return;
          }
          if (value) {
            e.target.classList.add('filled');
            if (index < otpDigits.length - 1) {
              otpDigits[index + 1].focus();
            }
          } else {
            e.target.classList.remove('filled');
          }
          updateOtpValue();
        });

        input.addEventListener('keydown', function (e) {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpDigits[index - 1].focus();
          }
        });

        input.addEventListener('paste', function (e) {
          e.preventDefault();
          const pastedData = e.clipboardData.getData('text');
          const digits = pastedData.replace(/\D/g, '').split('').slice(0, 6);

          digits.forEach((digit, i) => {
            if (otpDigits[i]) {
              otpDigits[i].value = digit;
              otpDigits[i].classList.add('filled');
            }
          });

          const nextEmptyIndex = digits.length < 6 ? digits.length : 5;
          if (otpDigits[nextEmptyIndex]) {
            otpDigits[nextEmptyIndex].focus();
          }
          updateOtpValue();
        });
      });
    }

    function updateOtpValue() {
      const otpValue = Array.from(otpDigits)
        .map((input) => input.value)
        .join('');
      otpHiddenInput.value = otpValue;
    }

    function clearOtpInputs() {
      otpDigits.forEach((input) => {
        input.value = '';
        input.classList.remove('filled');
      });
      otpHiddenInput.value = '';
      if (otpDigits[0]) otpDigits[0].focus();
    }

    function getOtpValue() {
      return Array.from(otpDigits)
        .map((input) => input.value)
        .join('');
    }

    function checkFormValidity() {
      const firstName = firstNameInput.value.trim();
      const lastName = lastNameInput.value.trim();
      const phone = phoneInput.value.trim();
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      const isValid =
        firstName &&
        lastName &&
        phone &&
        validatePhoneNumber(phone) &&
        password &&
        confirmPassword &&
        password === confirmPassword &&
        isOtpSent;

      registerButton.disabled = !isValid;
    }

    if (sendOtpButton) {
      sendOtpButton.addEventListener('click', async () => {
        const phoneNumber = phoneInput.value.trim();
        hideResponseMessage();

        if (!phoneNumber) {
          showResponseMessage('Please enter a phone number first.', 'error-text');
          return;
        }

        if (!validatePhoneNumber(phoneNumber)) {
          showResponseMessage('Please enter a valid Bangladesh phone number.', 'error-text');
          return;
        }

        const cleanedPhoneNumber = cleanPhoneNumber(phoneNumber);

        phoneInput.disabled = true;
        sendOtpButton.disabled = true;
        sendOtpButton.textContent = 'Sending...';
        showMessage(otpMessage, '', '');
        isOtpSent = false;
        registerButton.disabled = true;
        clearOtpInputs();

        try {
          const response = await fetch(`${API_BASE_URL}/send-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: cleanedPhoneNumber, register: true }),
          });
          const data = await response.json();

          if (response.ok) {
            otpContainer.classList.add('active');
            if (otpDigits[0]) otpDigits[0].focus();
            sendOtpButton.textContent = 'Resend OTP';
            showMessage(otpMessage, 'OTP sent to your phone.', 'success-text');
            isOtpSent = true;
            checkFormValidity();
          } else {
            sendOtpButton.textContent = 'Send OTP';
            showResponseMessage(data.message || 'Failed to send OTP. Please try again.', 'error-text');
          }

          phoneInput.disabled = false;
          sendOtpButton.disabled = false;
        } catch (error) {
          showResponseMessage('An error occurred while trying to send OTP.', 'error-text');
          phoneInput.disabled = false;
          sendOtpButton.disabled = false;
          sendOtpButton.textContent = 'Send OTP';
        }
      });
    }

    [firstNameInput, lastNameInput, phoneInput, passwordInput, confirmPasswordInput].forEach((input) => {
      if (input) {
        input.addEventListener('input', checkFormValidity);
      }
    });

    if (registerButton) {
      registerButton.addEventListener('click', async () => {
        hideResponseMessage();

        if (!isOtpSent) {
          showResponseMessage('Please send and verify OTP first.', 'error-text');
          return;
        }

        if (!validatePhoneNumber(phoneInput.value.trim())) {
          showResponseMessage('Please enter a valid Bangladesh phone number.', 'error-text');
          return;
        }

        if (passwordInput.value !== confirmPasswordInput.value) {
          showResponseMessage('Passwords do not match.', 'error-text');
          return;
        }

        const otpValue = getOtpValue();
        if (otpValue.length !== 6) {
          showResponseMessage('Please enter the complete 6-digit OTP.', 'error-text');
          return;
        }

        registerButton.disabled = true;
        registerButton.textContent = 'Registering...';

        const formData = {
          first_name: firstNameInput.value.trim(),
          last_name: lastNameInput.value.trim(),
          phone: cleanPhoneNumber(phoneInput.value.trim()),
          email: emailInput.value.trim() || undefined,
          password: passwordInput.value,
          otp: otpValue,
        };

        try {
          const response = await fetch(`${API_BASE_URL}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          if (response.ok) {
            showResponseMessage('Registration successful! Redirecting to login...', 'success-text');
            setTimeout(() => {
              window.location.href = '/account/login';
            }, 2000);
          } else {
            showResponseMessage(data.message || 'Registration failed. Please try again.', 'error-text');
          }
        } catch (error) {
          showResponseMessage('An error occurred during registration. Please try again.', 'error-text');
        } finally {
          registerButton.disabled = false;
          registerButton.textContent = '{{ "customer.register.submit" | t | default: "Submit" }}';
          checkFormValidity();
        }
      });
    }

    setupOtpInputs();
    checkFormValidity();
  });
</script>

{% schema %}
{
  "name": "Register",
  "settings": []
}
{% endschema %}
