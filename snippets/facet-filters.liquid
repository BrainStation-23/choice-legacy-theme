{%- comment -%}
  Parameters:
  - results {Object} - Results object (collection or search).

  Usage:
  {% render 'facet-filters', results: collection, section: section %}
{%- endcomment -%}

{%- liquid
  assign has_price_filter = false
  assign active_filters_count = 0
  assign sort_by = results.sort_by | default: results.default_sort_by

  for filter in results.filters
    if filter.type == 'price_range'
      assign has_price_filter = true

      if filter.min_value.value
        assign active_filters_count = active_filters_count | plus: 1
      endif
      if filter.max_value.value
        assign active_filters_count = active_filters_count | plus: 1
      endif
    else
      assign active_filters_count = active_filters_count | plus: filter.active_values.size
    endif
  endfor

  if results.url
    if results.current_vendor or results.current_type
      assign clear_filters_url = results.url | append: '&sort_by=' | append: sort_by
    else
      assign clear_filters_url = results.url | append: '?sort_by=' | append: sort_by
    endif
  else
    assign terms = results.terms | escape
    assign types = results.types | join: ',' | escape
  endif

  if results.products_count
    assign results_count = results.products_count
  else
    assign results_count = results.results_count
  endif
-%}

{%- unless results.url -%}
  {%- capture clear_filters_url -%}
    ?type={{ types }}&options%5Bprefix%5D=last&q={{ terms }}&sort_by={{ sort_by }}
  {%- endcapture -%}
{%- endunless -%}

<link rel="stylesheet" href="{{ 'facet-filters.css' | asset_url }}">

{%- if has_price_filter -%}
  <link rel="stylesheet" href="{{ 'price-range.css' | asset_url }}">
{%- endif -%}

<script src="{{ 'facet-filters.js' | asset_url }}" defer="defer"></script>
{%- if has_price_filter -%}
  <script src="{{ 'price-range.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<facet-filters
  class="facets  flex gap-32 flex-col w-full has-motion"
  data-name="facet-filters"
  id="facet-filters"
  data-filtering="{{ section.settings.enable_filtering }}"
  data-sorting="{{ section.settings.enable_sorting }}"
  role="dialog"
  aria-labelledby="facets-title"
  aria-modal="true"
  aria-hidden="true"
  tabindex="-1"
>
  <div>
    <h1 class="p-0 m-0 ff-bebas-neue fs-36-lh-40-ls-0 fw-400">{{ results.title }}</h1>
    <h3 class="p-0 m-0 fw-400 ff-general-sans fs-14-lh-20-ls-0_1 ">
      {{ 'products.filtering.show_result_count.showing' | t: count: results.products_count }}
    </h3>
  </div>
  <div>
    <form id="facets" data-filter-section-id="{{ section.id }}" class="flex flex-col gap-16" novalidate>
      {%- if results.current_vendor or results.current_type -%}
        <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
      {%- elsif results.terms -%}
        <input type="hidden" name="q" value="{{ results.terms | escape }}">
        <input type="hidden" name="type" value="{{ types }}">
        <input name="options[prefix]" type="hidden" value="last">
      {%- endif -%}

      <!-- Add sort_by hidden input to maintain sorting when filtering -->
      <input type="hidden" name="sort_by" value="{{ results.sort_by | default: results.default_sort_by }}">

      <details-disclosure
        class="facets__active-filters"
        {% if active_filters_count == 0 %}
          hidden
        {% endif %}
      >
        <details
          class="disclosure"
          id="active-filters"
          {% if section.settings.expand_filters %}
            open
          {% endif %}
        >
          {%- liquid
            assign filter_count = 0
            for filter in results.filters
              for value in filter.active_values
                assign filter_count = filter_count | plus: 1
              endfor

              if filter.type == 'price_range'
                if filter.min_value.value != null or filter.max_value.value != null
                  assign filter_count = filter_count | plus: 1
                endif
              endif
            endfor
          -%}
          <summary>
            <div class="flex justify-between items-center">
              <span class="flex-auto fw-500 ff-general-sans fs-14-lh-20-ls-0_1">
                {%- if filter_count > 0 -%}
                  {{ 'products.filtering.applied_filter_count' | t: count: filter_count }}
                {%- else -%}
                  {{ 'products.filtering.applied_filters' | t }}
                {%- endif -%}
              </span>
              <span class="disclosure__toggle">
                {%- if settings.disclosure_toggle == 'plus' -%}
                  {% render 'icon-plus' %}
                {%- else -%}
                  {% render 'icon-arrow-down' %}
                {%- endif -%}
              </span>
            </div>
          </summary>
          <div class="disclosure__panel has-motion  pt-8">
            <div class=" flex flex-col gap-8">
              <div class="active-filters flex gap-8 flex-wrap  fw-400 ff-general-sans fs-14-lh-20-ls-0_1">
                {%- for filter in results.filters -%}
                  {%- for value in filter.active_values -%}
                    <a
                      href="{{ value.url_to_remove }}"
                      class="active-filter flex items-center text-current fw-500 ff-general-sans fs-14-lh-20-ls-0_1 text-brand"
                      {% if settings.preload_links %}
                        data-instant
                      {% endif %}
                    >
                      {%- render 'icon-close', height: 20, width: 20 %}
                      {%- if filter.type == 'boolean' %}{{ filter.label | escape }}:{% endif %}
                      {{ value.label | escape -}}
                    </a>
                  {%- endfor -%}

                  {% if filter.type == 'price_range' %}
                    {%- if filter.min_value.value != null or filter.max_value.value != null -%}
                      <a href="{{ filter.url_to_remove }}" class="active-filter flex items-center text-current">
                        {%- render 'icon-close' %}
                        {%- if filter.min_value.value -%}
                          {{- filter.min_value.value | money -}}
                        {%- else -%}
                          {{- 0 | money -}}
                        {%- endif %}
                        -
                        {% if filter.max_value.value -%}
                          {{- filter.max_value.value | money -}}
                        {%- else -%}
                          {{- filter.range_max | money -}}
                        {%- endif -%}
                      </a>
                    {%- endif -%}
                  {% endif %}
                {%- endfor -%}
              </div>

              <a
                href="{{ clear_filters_url }}"
                class="clear-filter-selected fw-500 ff-general-sans fs-12-lh-16-ls-0_6 text-primary"
                {% if settings.preload_links %}
                  data-instant
                {% endif %}
              >
                {{- 'products.filtering.clear_all' | t -}}
              </a>
            </div>
          </div>
        </details>
      </details-disclosure>

      <div class="facets__filters flex flex-col gap-16">
        {%- for filter in results.filters -%}
          {%- liquid
            assign swatches = false
            assign has_active_filters = false
            assign active_count = filter.active_values.size
            assign selectable_filter_count = 0

            if settings.filter_color_style == 'swatches' and settings.swatch_colors != blank and settings.swatch_option_name contains filter.label
              assign swatches = true
            endif

            if settings.filter_color_style == 'native'
              if filter.presentation == 'swatch' or filter.presentation == 'image'
                assign swatches = true
              endif
            endif

            if filter.type == 'price_range'
              if filter.min_value.value
                assign has_active_filters = true
                assign active_count = active_count | plus: 1
              endif
              if filter.max_value.value
                assign has_active_filters = true
                assign active_count = active_count | plus: 1
              endif
            else
              if active_count > 0
                assign has_active_filters = true
              endif
            endif
          -%}

          {%- capture filter_markup -%}
            {%- case filter.type -%}
              {%- when 'boolean' or 'list' -%}
                <ul class="p-0 flex gap-8 flex-col list-style-none">
                  {%- for value in filter.values -%}
                    {%- assign selectable_filter_count = selectable_filter_count | plus: 1 -%}
                    <li class="flex m-0 cursor-pointer pt-2 pb-2 px-2 rounded-6 list-style-none">
                      <input type="checkbox"
                              class="checkbox facet-checkbox   {% if value.count == 0 and value.active == false %}filter-disabled{% endif %}"
                              id="filter-{{ filter.param_name | escape }}-{{ forloop.index }}"
                              name="{{ value.param_name }}"
                              value="{{ value.value | escape }}"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                              data-filter-type="{{ filter.type }}"
                              data-filter-param="{{ filter.param_name }}">
                      <label for="filter-{{ filter.param_name | escape }}-{{ forloop.index }}"
                              class="fs-14-lh-20-ls-0_1 ff-general-sans fw-500 cursor-pointer {% if value.count == 0 and value.active == false %}filter-disabled{% endif %}"
                        {%- if swatches and settings.filter_color_style == 'swatches' %}
                            data-swatch="{{ value.label | replace: '"', '' | downcase }}"
                          {%- elsif swatches and settings.filter_color_style == 'native' -%}
                            data-swatch
                            {%- if value.swatch and value.swatch.image %}
                              style="--swatch-image: url({{ value.swatch.image | image_url: width: 40, height: 40, crop: 'center' }})"
                            {%- elsif value.swatch and value.swatch.color %}
                              style="--swatch-color: rgb({{ value.swatch.color.rgb }});--swatch-image: none;"
                            {%- endif %}
                          {% endif %}>
                        <span class="flex-auto">{{ value.label | escape }}</span>
                       
                      </label>
                    </li>
                  {%- endfor -%}
                </ul>

              {%- when 'price_range' -%}
                {%- assign selectable_filter_count = selectable_filter_count | plus: 1 -%}
                {% render 'price-range', filter: filter %}

            {%- endcase -%}
          {%- endcapture -%}

          {%- if selectable_filter_count > 0 -%}
            <details-disclosure>
              <details
                class="filter disclosure"
                id="filter-{{ filter.param_name | escape }}"
                data-type="{{ filter.type }}"
                {% if section.settings.expand_filters %}
                  open
                {% endif %}
              >
                <summary class="filter__toggle">
                  <div class="filter__toggle-item flex justify-between items-center border-b border-b-color border-b-solid">
                    <span class="flex-auto  fw-500 ff-general-sans fs-14-lh-20-ls-0_1  pb-8">
                      {{- filter.label | escape -}}
                    </span>
                    <span class="disclosure__toggle">
                      {%- if settings.disclosure_toggle == 'plus' -%}
                        {% render 'icon-plus' %}
                      {%- else -%}
                        {% render 'icon-arrow-down' %}
                      {%- endif -%}
                    </span>
                  </div>
                </summary>
                <div class="disclosure__panel has-motion pt-8">
                  <div class="flex flex-col gap-8">
                    <div class="filter__content">
                      {{ filter_markup }}
                    </div>

                    <div class="flex relative items-center">
                      <div class="filter__header">
                        <a
                          href="{{ filter.url_to_remove }}"
                          class="clear-filter-selected fw-500 ff-general-sans fs-12-lh-16-ls-0_6 text-primary"
                          {% if has_active_filters == false %}
                            hidden
                          {% endif %}
                        >
                          {{- 'products.filtering.clear' | t -}}
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </details>
            </details-disclosure>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </form>
  </div>
</facet-filters>
