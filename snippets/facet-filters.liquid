{%- comment -%}
  Parameters:
  - results {Object} - Results object (collection or search).
  - section {Object} - Section object.
  - unique_id {String} - Optional unique identifier for multiple instances.

  Usage:
  {% render 'facet-filters', results: collection, section: section, unique_id: 'desktop' %}
{%- endcomment -%}

<style>
  .filter-label {
    font-size: 14px !important;
  }

  /* Filtering spinner overlay styles */
  .filtering-spinner {
    backdrop-filter: blur(3px);
    transition: all 0.3s ease-in-out;
  }

  .filtering-spinner.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .filtering-spinner:not(.hidden) {
    opacity: 1;
    pointer-events: all;
  }

  @media (max-width: 768px) {
    #filter-button {
      display: flex;
    }
    .arrow-icon-filter svg path {
      fill: rgb(var(--color-border));
    }

    /* Overlay */
    .filter-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }

    .filter-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Mobile filter panel - mobile only */
    .main-products-grid__filters-mobile {
      display: none;
    }

    .main-products-grid__filters-mobile .disclosure__panel {
      position: relative !important;
      z-index: auto !important;
      transform: none !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      background: transparent !important;
      padding: 0 !important;
      margin-top: 8px !important;
    }

    .main-products-grid__filters-mobile .filter__toggle {
      border-bottom: 1px solid #eee !important;
    }

    .main-products-grid__filters-mobile .filter__toggle-item {
      border: none !important;
      padding: 0 !important;
    }

    .main-products-grid__filters-mobile .disclosure__toggle svg {
      transform: rotate(0deg) !important;
    }

    .main-products-grid__filters-mobile details[open] .disclosure__toggle svg {
      transform: rotate(180deg) !important;
    }
    .main-products-grid__filters-mobile {
      position: fixed !important;
      top: 0;
      right: -308px;
      width: 308px;
      max-width: 308px;
      height: 100%;
      background: rgb(var(--color-background));
      z-index: 9999;
      transform: translateX(0);
      opacity: 1;
      transition: right 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }

    .main-products-grid__filters-mobile.open {
      right: 0;
    }
  }
</style>

{%- liquid
  assign has_price_filter = false
  assign active_filters_count = 0
  assign sort_by = results.sort_by

  # Set default unique_id if not provided
  unless unique_id
    assign unique_id = 'default'
  endunless

  for filter in results.filters
    if filter.type == 'price_range'
      assign has_price_filter = true

      if filter.min_value.value
        assign active_filters_count = active_filters_count | plus: 1
      endif
      if filter.max_value.value
        assign active_filters_count = active_filters_count | plus: 1
      endif
    else
      assign active_filters_count = active_filters_count | plus: filter.active_values.size
    endif
  endfor

  if results.url
    if sort_by and sort_by != blank
      if results.current_vendor or results.current_type
        assign clear_filters_url = results.url | append: '&sort_by=' | append: sort_by
      else
        assign clear_filters_url = results.url | append: '?sort_by=' | append: sort_by
      endif
    else
      assign clear_filters_url = results.url
    endif
  else
    assign terms = results.terms | escape
    assign types = results.types | join: ',' | escape
  endif

  if results.products_count
    assign results_count = results.products_count
  else
    assign results_count = results.results_count
  endif
-%}

{%- unless results.url -%}
  {%- capture clear_filters_url -%}
    ?type={{ types }}&options%5Bprefix%5D=last&q={{ terms }}&sort_by={{ sort_by }}
  {%- endcapture -%}
{%- endunless -%}

<link rel="stylesheet" href="{{ 'facet-filters.css' | asset_url }}">

{%- if has_price_filter -%}
  <link rel="stylesheet" href="{{ 'price-range.css' | asset_url }}">
{%- endif -%}

<script src="{{ 'facet-filters.js' | asset_url }}" defer="defer"></script>
{%- if has_price_filter -%}
  <script src="{{ 'price-range.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<div class=" flex flex-col gap-8  items-center justify-center ">
  <facet-filters
    class="facets  flex gap-32 sm:gap-16 flex-col w-full has-motion"
    data-name="facet-filters-{{ unique_id }}"
    id="facet-filters-{{ unique_id }}"
    data-filtering="{{ section.settings.enable_filtering }}"
    data-sorting="{{ section.settings.enable_sorting }}"
    role="dialog"
    aria-labelledby="facets-title"
    aria-modal="true"
    aria-hidden="true"
    tabindex="-1"
  >
    <div class="flex justify-between items-center ">
      <div class="flex gap-2 flex-col">
        <h1 class="p-0 m-0 ff-bebas-neue fs-36-lh-40-ls-0 fw-400">{{ results.title }}</h1>
        <h3 class="p-0 m-0 fw-400 ff-general-sans fs-14-lh-20-ls-0_1 ">
          {{ 'products.filtering.show_result_count.showing' | t: count: results.products_count }}
        </h3>
      </div>
      <div class="hidden sm:block" id="filter-close-button-{{ unique_id }}">
        {% render 'close-button' %}
      </div>
    </div>
    <div class="">
      <form
        id="facets-{{ unique_id }}"
        data-filter-section-id="{{ section.id }}"
        class="flex flex-col gap-16"
        novalidate
      >
        {%- if results.current_vendor or results.current_type -%}
          <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
        {%- elsif results.terms -%}
          <input type="hidden" name="q" value="{{ results.terms | escape }}">
          <input type="hidden" name="type" value="{{ types }}">
          <input name="options[prefix]" type="hidden" value="last">
        {%- endif -%}

        <!-- Add sort_by hidden input to maintain sorting when filtering (only if explicitly set) -->
        {%- if results.sort_by and results.sort_by != blank -%}
          <input type="hidden" name="sort_by" value="{{ results.sort_by }}">
        {%- endif -%}

        <div class="facets__filters flex flex-col gap-8">
          {%- for filter in results.filters -%}
            {%- liquid
              assign swatches = false
              assign has_active_filters = false
              assign active_count = filter.active_values.size
              assign selectable_filter_count = 0

              if settings.filter_color_style == 'swatches' and settings.swatch_colors != blank and settings.swatch_option_name contains filter.label
                assign swatches = true
              endif

              if settings.filter_color_style == 'native'
                if filter.presentation == 'swatch' or filter.presentation == 'image'
                  assign swatches = true
                endif
              endif

              if filter.type == 'price_range'
                if filter.min_value.value
                  assign has_active_filters = true
                  assign active_count = active_count | plus: 1
                endif
                if filter.max_value.value
                  assign has_active_filters = true
                  assign active_count = active_count | plus: 1
                endif
              else
                if active_count > 0
                  assign has_active_filters = true
                endif
              endif
            -%}

            {%- capture filter_markup -%}
            {%- case filter.type -%}
              {%- when 'boolean' or 'list' -%}
                <ul class="p-0 flex gap-8 flex-col list-style-none">
                  {%- for value in filter.values -%}
                    {%- assign selectable_filter_count = selectable_filter_count | plus: 1 -%}
                    <li class="flex m-0 cursor-pointer pt-2 pb-2 px-2 rounded-6 list-style-none">
                      <input type="checkbox"
                              class="checkbox facet-checkbox   {% if value.count == 0 and value.active == false %}filter-disabled{% endif %}"
                              id="filter-{{ filter.param_name | escape }}-{{ forloop.index }}-{{ unique_id }}"
                              name="{{ value.param_name }}"
                              value="{{ value.value | escape }}"
                              {% if value.active %}checked{% endif %}
                              {% if value.count == 0 and value.active == false %}disabled{% endif %}
                              data-filter-type="{{ filter.type }}"
                              data-filter-param="{{ filter.param_name }}">
                      <label for="filter-{{ filter.param_name | escape }}-{{ forloop.index }}-{{ unique_id }}"
                              class="filter-label fs-14-lh-20-ls-0_1 ff-general-sans fw-500 cursor-pointer {% if value.count == 0 and value.active == false %}filter-disabled{% endif %}"
                        {%- if swatches and settings.filter_color_style == 'swatches' %}
                            data-swatch="{{ value.label | replace: '"', '' | downcase }}"
                          {%- elsif swatches and settings.filter_color_style == 'native' -%}
                            data-swatch
                            {%- if value.swatch and value.swatch.image %}
                              style="--swatch-image: url({{ value.swatch.image | image_url: width: 40, height: 40, crop: 'center' }})"
                            {%- elsif value.swatch and value.swatch.color %}
                              style="--swatch-color: rgb({{ value.swatch.color.rgb }});--swatch-image: none;"
                            {%- endif %}
                          {% endif %}>
                        <span class="flex-auto">{{ value.label | escape }}</span>
                       
                      </label>
                    </li>
                  {%- endfor -%}
                </ul>

              {%- when 'price_range' -%}
                {%- assign selectable_filter_count = selectable_filter_count | plus: 1 -%}
                {% render 'price-range', filter: filter %}

            {%- endcase -%}
          {%- endcapture -%}

            {%- if selectable_filter_count > 0 -%}
              <details-disclosure>
                <details
                  class="filter disclosure"
                  id="filter-{{ filter.param_name | escape }}-{{ unique_id }}"
                  data-type="{{ filter.type }}"
                  {% if section.settings.expand_filters %}
                    open
                  {% endif %}
                >
                  <summary class="filter__toggle">
                    <div class="filter__toggle-item flex justify-between items-center border-b border-b-color border-b-solid">
                      <span class="flex-auto  fw-500 ff-general-sans fs-14-lh-20-ls-0_1">
                        {{- filter.label | escape -}}
                      </span>
                      <span class="disclosure__toggle">
                        {%- if settings.disclosure_toggle == 'plus' -%}
                          {% render 'icon-plus' %}
                        {%- else -%}
                          {% render 'icon-arrow-down', height: '32', width: '32' %}
                        {%- endif -%}
                      </span>
                    </div>
                  </summary>
                  <div class="disclosure__panel has-motion pt-8">
                    <div class="flex flex-col gap-8">
                      <div class="filter__content">
                        {{ filter_markup }}
                      </div>
                    </div>
                  </div>
                </details>
              </details-disclosure>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </form>
    </div>
  </facet-filters>
  <a
    href="{{ clear_filters_url }}"
    class="clear-filter-selected fw-600 ff-general-sans fs-14-lh-100pct-ls-0 text-brand h-40 flex items-center"
    {% if settings.preload_links %}
      data-instant
    {% endif %}
  >
    {{- 'products.filtering.clear_all' | t -}}
  </a>
</div>
