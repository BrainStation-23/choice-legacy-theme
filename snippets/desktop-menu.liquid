<nav class="mega-menu relative z-1000 bg-brand">
  <div class="mega-menu__nav page-width">
    <div class="mega-menu__container">
      <ul class="mega-menu__list m-0 p-0 list-style-none flex items-center justify-center gap-24">
        {%- if section.settings.main_menu != blank -%}
          {%- for link in linklists[section.settings.main_menu].links -%}
            <li class="mega-menu__item">
              {% assign undergarments_link = link.title | downcase %}
              <a
                href="{{ link.url }}"
                class="mega-menu__link fw-600 fs-14-lh-100pct-ls-2pct uppercase {% if undergarments_link contains "undergarments" %}mega-menu__link--undergarments{% endif %}"
              >
                {{ link.title }}
              </a>

              {%- if link.links != blank -%}
                {%- comment -%} Count columns for dynamic layout {%- endcomment -%}
                {%- assign column_count = 0 -%}
                {%- assign has_2level_items = false -%}
                {%- for child_link in link.links -%}
                  {%- if child_link.links != blank -%}
                    {%- assign column_count = column_count | plus: 1 -%}
                  {%- else -%}
                    {%- assign has_2level_items = true -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- comment -%} If we have 2-level items, they count as one column {%- endcomment -%}
                {%- if has_2level_items -%}
                  {%- assign column_count = column_count | plus: 1 -%}
                {%- endif -%}

                {%- comment -%} Determine if we should show image (2+ columns) {%- endcomment -%}
                {%- assign show_image = false -%}
                {%- if column_count >= 2 -%}
                  {%- assign show_image = true -%}
                {%- endif -%}

                {%- comment -%} Determine dropdown width class based on column count {%- endcomment -%}
                {%- assign dropdown_class = 'mega-menu__dropdown' -%}
                {%- if column_count == 1 -%}
                  {%- assign dropdown_class = dropdown_class | append: ' mega-menu__dropdown--1-column' -%}
                {%- elsif column_count == 2 -%}
                  {%- assign dropdown_class = dropdown_class | append: ' mega-menu__dropdown--2-columns' -%}
                {%- elsif column_count == 3 -%}
                  {%- assign dropdown_class = dropdown_class | append: ' mega-menu__dropdown--3-columns' -%}
                {%- else -%}
                  {%- assign dropdown_class = dropdown_class | append: ' mega-menu__dropdown--4-plus-columns' -%}
                {%- endif -%}

                <div class="{{ dropdown_class }} box-shadow">
                  <div class="mega-menu__dropdown-inner">
                    <div class="mega-menu__columns-wrapper">
                      {%- assign column_rendered = false -%}
                      {%- for child_link in link.links -%}
                        {%- if child_link.links != blank -%}
                          <!-- 3-level menu: child has grandchildren -->
                          <div class="mega-menu__column flex flex-col gap-16">
                            <h3 class="mega-menu__column-title uppercase fs-21-lh-24-ls-1_2pct fw-400">
                              {{ child_link.title }}
                            </h3>
                            <ul class="mega-menu__column-list flex flex-col gap-16">
                              {%- for grandchild_link in child_link.links -%}
                                <li class="mega-menu__column-item">
                                  <a
                                    href="{{ grandchild_link.url }}"
                                    class="mega-menu__column-link fs-14-lh-20-ls-0_1 fw-500"
                                  >
                                    {{- grandchild_link.title -}}
                                  </a>
                                </li>
                              {%- endfor -%}
                            </ul>
                          </div>
                        {%- else -%}
                          <!-- 2-level menu: child has no grandchildren -->
                          {%- unless column_rendered -%}
                            <div class="mega-menu__column flex flex-col gap-16">
                              <ul class="mega-menu__column-list flex flex-col gap-16">
                                {%- assign column_rendered = true -%}
                          {%- endunless -%}
                          <li class="mega-menu__column-item">
                            <a href="{{ child_link.url }}" class="mega-menu__column-link fs-14-lh-20-ls-0_1 fw-500">
                              {{- child_link.title -}}
                            </a>
                          </li>
                        {%- endif -%}
                      {%- endfor -%}

                      {%- comment -%} Close the column if we had 2-level items {%- endcomment -%}
                      {%- if has_2level_items -%}
                        </ul>
                        </div>
                      {%- endif -%}
                    </div>

                    <!-- Image Column - Only show when column count >= 2 -->
                    {%- if section.settings.mega_menu_image != blank and show_image -%}
                      <div
                        class="mega-menu__image-column flex flex-start media relative block"
                        style="padding-top: 200px; padding-left: 402px;"
                      >
                        {%- capture sizes %}{% render 'sizes-attribute' %}{% endcapture -%}

                        {%- if section.settings.mega_menu_image_link != blank -%}
                          <a href="{{ section.settings.mega_menu_image_link }}" class="mobile-mega-menu__image-link">
                        {%- endif -%}
                          {% render 'image',
                            image: section.settings.mega_menu_image,
                            widths: '293, 293, 293, 293',
                            src_width: 293,
                            sizes: sizes,
                            class: 'img-fit',
                            quality: 1
                          %}
                        {%- if section.settings.mega_menu_image_link != blank -%}
                          </a>
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  </div>
                </div>
              {%- endif -%}
            </li>
          {%- endfor -%}
        {%- endif -%}
      </ul>
    </div>
  </div>
</nav>