<style>
  .variant-picker__radio-input:checked + .variant-picker__label,
  .variant-picker__radio-input:checked + .variant-picker__label--swatch {
    border-color: rgb(var(--color-primary-brand));
    border-width: 2px;
  }

  .variant-picker__label.unavailable {
    text-decoration: line-through;
    opacity: 0.4;
    cursor: not-allowed;
  }
</style>

<variant-picker 
  class="variant-picker-element block mt-24 mb-24 flex flex-col gap-16" 
  data-section-id="{{ section.id }}" data-product-url="{{ product.url | within: collection }}"
  data-product-url="{{ product.url | within: collection }}"
  data-initial-variant-id="{{ product.selected_or_first_available_variant.id }}"
>
  {%- for option in product.options_with_values -%}
    <fieldset class="variant-picker__option-group border-none m-0 p-0 flex flex-col gap-8" role="radiogroup">
      
      {%- if product.type == 'Combo products' -%}
        {%- liquid
          assign name_parts = option.name | split: '('
          assign main_title = name_parts | first | strip
          assign option_label = name_parts | last | remove: ')' | strip
          assign main_title_handle = main_title | handle
        -%}
        <div class="border-1 border-solid border-color pt-6 pr-10 pb-6 pl-10 rounded-6 flex gap-8 max-w-392">
          <div class="w-32 h-32 media block relative">
            {%- capture sizes %}{% render 'sizes-attribute', grid: true, min: 1, sm: 1, lg: 1, xl: 1 %}{% endcapture -%}
            {% render 'image',
              image: all_products[main_title_handle].featured_image,
              widths: '32, 32, 32, 32',
              src_width: 32,
              sizes: sizes,
              class: 'img-fit',
              quality: 1
            %}
          </div>
          <div class="flex flex-col gap-4">
            <legend class="variant-picker__option-name fw-500 fs-14-lh-20-ls-0_1 text-primary block">{{ main_title }}</legend>
            <p class="text-brand fw-500 fs-12-lh-16-ls-0_6">à§³ {{ all_products[main_title_handle].price | divided_by: 100.0 }}</p>
          </div>
        </div>
        <span class="text-secondary block fw-500 fs-14-lh-20-ls-0_1">{{ option_label }}: {{ option.selected_value }}</span>
      {%- else -%}
        <legend class="variant-picker__option-name fw-500 fs-14-lh-20-ls-0_1 text-primary block">{{ option.name }}</legend>
      {%- endif -%}

      <div class="variant-picker__values flex flex-wrap gap-8">
        {%- for value in option.values -%}
          {%- liquid
            assign is_color_option = false
            assign downcased_option_name = option.name | downcase
            assign first_character = value | slice: 0, 1
            if downcased_option_name == 'color' or downcased_option_name == 'colour'
              assign is_color_option = true
              assign color_handle = value | handle
              assign color_swatch_image_file = color_handle | append: '.png'
              assign color_swatch_asset_url = images[color_swatch_image_file] | image_url: width: 44
            elsif product.type == "Combo products" and first_character == "#"
              assign is_color_option = true
            endif
          -%}
          <div class="variant-picker__value-wrapper">
            <input
              type="radio"
              id="option-{{ option.position }}-{{ forloop.index }}"
              name="option-{{ option.position }}"
              value="{{ value | escape }}"
              {% if option.selected_value == value %}checked{% endif %}
              class="variant-picker__radio-input h-0 p-0 border-none w-0 opacity-0 pointer-events-none absolute"
            >
            <label
              for="option-{{ option.position }}-{{ forloop.index }}"
              class="variant-picker__label flex items-center justify-center relative cursor-pointer left-0-priority pointer-events-auto fw-500 fs-13-lh-16-ls-0_2-priority border-0 border-solid {% if is_color_option %}variant-picker__label--swatch w-36 h-36 rounded-12{% else %}min-w-64 h-44 border-1 border-color rounded-100 pt-18 pr-16 pb-18 pl-16{% endif %}"
              style="
                {%- if is_color_option -%}
                  {%- if images[color_swatch_image_file] != blank -%}
                    background-image: url({{ color_swatch_asset_url }});
                  {%- else -%}
                    background-color: {% if value.swatch.color != blank %}{{ value.swatch.color }}{% else %}{{ value }}{% endif %};
                  {%- endif -%}
                {%- endif -%}
              "
            >
              {% if is_color_option == false %}{{ value }}{% endif %}
            </label>
          </div>
        {%- endfor -%}
      </div>
    </fieldset>
  {%- endfor -%}
</variant-picker>

<script>
  class VariantPicker extends HTMLElement {
    constructor() {
      super();
      this.variants = {{ product.variants | json }};
      this.addEventListener('change', this.onVariantChange);
      
      // Use requestAnimationFrame to ensure DOM is fully ready
      requestAnimationFrame(() => {
        this._selectVariantFromUrl();
        this._updateAvailability();
      });
    }

    onVariantChange() {
      const selectedVariant = this.getSelectedVariant();
      if (!selectedVariant) return;

      const browserUrl = `${this.dataset.productUrl}?variant=${selectedVariant.id}`;
      const fetchUrl = `${browserUrl}&section_id=${this.dataset.sectionId}`;

      this.updateURL(browserUrl);
      this.fetchAndUpdateSection(fetchUrl, selectedVariant);
      this._updateLegends(selectedVariant);
      this._updateAvailability();
    }

    _updateAvailability() {
      const currentSelections = Array.from(this.querySelectorAll('.variant-picker__option-group')).map(fieldset => 
        fieldset.querySelector('input:checked')?.value
      );

      this.querySelectorAll('.variant-picker__option-group').forEach((fieldset, optionIndex) => {
        fieldset.querySelectorAll('.variant-picker__value-wrapper').forEach(wrapper => {
          const input = wrapper.querySelector('input');
          const label = wrapper.querySelector('label');
          const value = input.value;

          let tempOptions = [...currentSelections];
          tempOptions[optionIndex] = value;

          const isAvailable = this.variants.some(variant => {
            const matches = variant.options.every((opt, i) => opt === tempOptions[i]);
            return matches && variant.available;
          });

          if (isAvailable) {
            label.classList.remove('unavailable');
            input.disabled = false;
          } else {
            label.classList.add('unavailable');
            input.disabled = true;
          }
        });
      });
    }

    _selectVariantFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      let variantId = urlParams.get('variant');
      
      // If no variant in URL, use the initial one passed from Liquid
      if (!variantId) {
        variantId = this.dataset.initialVariantId;
      }

      const targetVariant = this.variants.find(v => v.id.toString() === variantId);

      if (!targetVariant) {
        console.warn('Initial or URL variant not found.');
        return;
      }

      // Select the radio buttons for the target variant
      targetVariant.options.forEach((optionValue, index) => {
        // Use CSS.escape for values that might contain special characters like quotes
        const escapedValue = CSS.escape(optionValue);
        const selector = `input[name="option-${index + 1}"][value="${escapedValue}"]`;
        const radioButton = this.querySelector(selector);
        if (radioButton) {
          radioButton.checked = true;
        }
      });
      
      this._updateLegends(targetVariant);
      this.setActiveMedia(targetVariant);
    }

    _updateLegends(variant) {
      {% comment %} if (!variant) return;
      this.querySelectorAll('.variant-picker__option-group').forEach((fieldset, index) => {
        const legend = fieldset.querySelector('.variant-picker__option-name');
        const optionName = legend.textContent.split(':')[0].trim();
        const selectedValue = variant.options[index];
        legend.textContent = `${optionName}: ${selectedValue}`;
      }); {% endcomment %}
    }

    getSelectedVariant() {
      const selectedOptions = Array.from(this.querySelectorAll('input[type="radio"]:checked')).map(input => input.value);
      return this.variants.find(variant => {
        return variant.options.every((optionValue, index) => {
          return selectedOptions[index] === optionValue;
        });
      });
    }

    updateURL(url) {
      window.history.replaceState({}, '', url);
    }

    fetchAndUpdateSection(url, variant) {
      const productGrid = document.querySelector('.product-grid');
      if (productGrid) productGrid.style.opacity = '0.5';

      fetch(url)
        .then(response => response.text())
        .then(responseText => {
          const newHtml = new DOMParser().parseFromString(responseText, 'text/html');
          
          const newInfo = newHtml.querySelector(`#product-info-${this.dataset.sectionId}`);
          const oldInfo = document.querySelector(`#product-info-${this.dataset.sectionId}`);
          if (newInfo && oldInfo) oldInfo.innerHTML = newInfo.innerHTML;

          const newMedia = newHtml.querySelector(`#product-media-${this.dataset.sectionId}`);
          const oldMedia = document.querySelector(`#product-media-${this.dataset.sectionId}`);
          if (newMedia && oldMedia) oldMedia.innerHTML = newMedia.innerHTML;
          
          this.setActiveMedia(variant);
        })
        .catch(e => console.error('Variant Picker: Error during fetch:', e))
        .finally(() => {
          if (productGrid) productGrid.style.opacity = '1';
        });
    }
    
    setActiveMedia(variant) {
      if (!variant || !variant.featured_media) return;
      
      const featuredMediaId = variant.featured_media.id.toString();
      const gallery = document.querySelector(`product-media-gallery`);

      if (!gallery) return;

      const setMedia = () => {
        gallery.setActiveMediaById(featuredMediaId);
      };

      // Check if the gallery's swiper is already initialized and ready
      if (gallery.swiper) {
        setMedia();
      } else {
        // If not, wait for the gallery to announce it's ready
        gallery.addEventListener('gallery:ready', setMedia, { once: true });
      }
    }
  }

  if (!customElements.get('variant-picker')) {
    customElements.define('variant-picker', VariantPicker);
  }
</script>