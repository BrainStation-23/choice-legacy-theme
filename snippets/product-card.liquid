{% comment %}
  Usage: {% render 'product-card', product: product, image_width: 268, image_height: 268 %}

  Parameters:
  - product: Product object (optional - will show placeholder if not provided)
  - image_width: Image width (default: 268)
  - image_height: Image height (default: 268)
  - css_classes: Additional CSS classes (default: '')
  - loading: Image loading attribute (default: 'lazy')
{% endcomment %}

<style>
  .product-card {
    border-radius: {{ settings.product_card_border_radius }}px;
  }

  .product-card__image-container {
    border-radius: {{ settings.product_card_border_radius }}px {{ settings.product_card_border_radius }}px 0 0;
  }
</style>

{% assign product = product | default: null %}
{% assign show_type = settings.show_product_type %}
{% assign show_rating = settings.show_product_rating %}
{% assign show_weight = settings.show_product_weight %}
{% assign show_wishlist_button = settings.show_wishlist_button %}
{% assign image_width = image_width | default: 268 %}
{% assign image_height = image_height | default: 268 %}
{% assign css_classes = css_classes | default: '' %}
{% assign loading = loading | default: 'lazy' %}
{% assign image_ratio = 1 %}

<div
  class="product-card bg-bg h-full cursor-pointer relative flex flex-col transition-transform rounded-6 {% if width != "auto" %}w-240 lg:w-full md:w-full sm:w-auto{% else %}w-auto{% endif %} {{ css_classes }} {% if settings.show_product_card_box_shadow %}box-shadow{% endif %}"
  {% if product %}
    data-product-id="{{ product.id }}"
  {% endif %}
>
  <div class="product-card__image-container w-full relative overflow-hidden">
    {% if product and product != empty %}
      {% if product.featured_image %}
        {%- capture sizes %}{% render 'sizes-attribute', grid: true, min: 2, sm: 2, lg: 2, xl: 2 %}{% endcapture -%}
        <div class="media w-full" style="padding-top: {{ 1 | divided_by: image_ratio | times: 100 }}%;">
          {% render 'image',
            image: product.featured_image,
            src_width: image_width,
            widths: '177, 268, 268, 268, 268',
            alt_text: product.title,
            class: 'img-fit',
            quality: 1,
            sizes: sizes
          %}
        </div>
      {% else %}
        <div class="product-card__placeholder-image">
          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
        </div>
      {% endif %}

      <!-- Product Weight Display -->
      {% if show_weight %}
        {%- if product.variants.first.weight > 0 -%}
          {%- liquid
            assign a_weight = product.variants.first.weight
            for variant in product.variants
              if variant.weight != a_weight
                assign a_weight = false
              endif
            endfor
          -%}
          {%- if a_weight -%}
            <div class="product-card__weight absolute bottom-8 right-8 pt-4 pr-8 pb-4 pl-8 fw-500 fs-14-lh-16-ls-0">
              {{ weight_value -}}
              {{- weight_unit }}
            </div>
          {%- endif -%}
        {%- endif -%}
      {% endif %}

      {% if show_wishlist_button %}
        {% render 'wishlist-button', product: product, cls: 'w-32 h-32 bg-transparent absolute top-16 right-16 z-2' %}
      {% endif %}
    {% else %}
      <div class="product-card__placeholder-image">
        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
      </div>
      <!-- Placeholder weight -->
      {% if show_weight %}
        <div class="product-card__weight absolute bottom-8 right-8 pt-4 pr-8 pb-4 pl-8 fw-500 fs-14-lh-16-ls-0">
          {{ 'sections.product.placeholder.weight' | t }}
        </div>
      {% endif %}

      {% if show_wishlist_button %}
        {% render 'wishlist-button', cls: 'w-32 h-32 bg-transparent absolute top-16 right-16 z-2' %}
      {% endif %}
    {% endif %}
  </div>

  <div class="product-card__content pt-8 pr-12 pb-8 pl-12 flex flex-col justify-between flex-1 gap-12">
    {% if product != empty %}
      <div class="flex flex-col gap-6">
        <div class="flex flex-col gap-4">
          {% if show_type and product.type != blank %}
            {% assign collection_handle = product.type | handleize %}
            {% assign collection_url = routes.collections_url | append: '/' | append: collection_handle %}
            <a
              href="{{ collection_url }}"
              class="product-card__type-link relative z-3 no-underline text-inherit flex items-center"
              onclick="event.stopPropagation();"
            >
              <p class="product-card__type rounded-100 pt-2 pr-8 pb-2 pl-8 cursor-pointer relative z-2 min-h-24 bg-brand-2 fw-500 fs-11-lh-11-ls--0_275 flex items-center">
                {{ product.type }}
              </p>
            </a>
          {% endif %}

          <h3 class="product-card__title ff-general-sans fw-400 fs-14-lh-20-ls-0">{{ product.title }}</h3>
        </div>

        <div class="flex flex-col gap-8">
          {% if product.price %}
            <div class="product-card__pricing flex flex-wrap items-center gap-8">
              <span class="product-card__price text-brand fw-600 fs-14-lh-20-ls-0_1">
                {{ product.price | money_without_trailing_zeros }}
              </span>
              {% if product.compare_at_price > product.price %}
                <span class="product-card__compare-price line-through fw-500 fs-14-lh-20-ls-0_1">
                  {{ product.compare_at_price | money_without_trailing_zeros }}
                </span>
                {% assign discount_amount = product.compare_at_price | minus: product.price %}
                {% assign discount_percentage = discount_amount
                  | times: 100.0
                  | divided_by: product.compare_at_price
                  | round
                %}
                <span class="product-card__discount text-brand fw-400 fs-14-lh-20-ls-0_1">
                  {{ discount_percentage }}% {{ 'sections.product.placeholder.off' | t }}
                </span>
              {% endif %}
            </div>
          {% endif %}

          <div class="flex flex-col gap-12">
            {% assign product_rating_cnt = product.metafields.choice_legacy_reviews.rating_count %}

            {% if show_rating and product_rating_cnt > 0 %}
              <div class="flex items-center gap-4">
                <div class="product-card__rating rounded-100 pt-2 pr-4 pb-2 pl-7 text-bg bg-brand flex items-center flex gap-4">
                  <span class="fw-500 fs-11-lh-normal-ls-0_5">
                    {{- product.metafields.choice_legacy_reviews.avg_rating -}}
                  </span>
                  {% render 'icon-star', cls: "w-14 h-14" %}
                </div>
                <span class="product-card__rating-cnt text-label fw-500 fs-11-lh-11-ls--0_275"
                  >({{ product_rating_cnt }})</span
                >
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {% render 'product-form' %}
    {% else %}
      <!-- Placeholder content -->
      <div class="flex flex-col gap-6">
        <div class="flex flex-col gap-4">
          {% if show_type %}
            <a
              href="#"
              class="product-card__type-link relative z-3 no-underline text-inherit flex items-center"
              onclick="event.stopPropagation();"
            >
              <p class="product-card__type rounded-100 pt-2 pr-8 pb-2 pl-8 cursor-pointer relative z-2 min-h-24 bg-brand-2 fw-500 fs-11-lh-11-ls--0_275 flex items-center">
                {{ 'sections.product.placeholder.product_type' | t }}
              </p>
            </a>
          {% endif %}

          <h3 class="product-card__title ff-general-sans fw-400 fs-14-lh-20-ls-0">
            {{ 'sections.product.placeholder.product_title' | t }}
          </h3>
        </div>
        <div class="flex flex-col gap-8">
          <div class="product-card__pricing flex flex-wrap items-center gap-8">
            <span class="product-card__price text-brand fw-600 fs-14-lh-20-ls-0_1">
              {{ 'sections.product.placeholder.price' | t }}
            </span>
          </div>

          <div class="flex flex-col gap-12">
            {% if show_rating %}
              <div class="flex items-center gap-4">
                <div class="product-card__rating rounded-100 pt-2 pr-4 pb-2 pl-4 text-bg bg-brand flex items-center flex gap-4">
                  <span class="fw-500 fs-11-lh-normal-ls-0_5">{{ 'sections.product.placeholder.avg_rating' | t }}</span>
                  {% render 'icon-star', cls: "w-14 h-14" %}
                </div>

                <span class="product-card__rating-cnt text-label fw-500 fs-11-lh-11-ls--0_275"
                  >({{ 'sections.product.placeholder.rating_cnt' | t }})</span
                >
              </div>
            {% endif %}

            {% render 'product-form' %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  {% if product and product != empty %}
    <a
      href="{{ product.url }}"
      class="product-card__link absolute top-0 left-0 w-full h-full z-1 no-underline"
      aria-label="{{ product.title }}"
    >
      <span class="visually-hidden">{{ product.title }}</span>
    </a>
  {% endif %}
</div>
