{% comment %}
  Renders cart drawer

  Accepts:
  - cart: cart object

  Usage:
  {% render 'cart-drawer' %}
{% endcomment %}

<cart-drawer id="cart-drawer" class="cart-drawer">
  <div class="cart-drawer__overlay"></div>
  <div class="cart-drawer__inner">
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__title">{{ 'sections.cart.title' | t }}</h2>
      <button class="cart-drawer__close" type="button" aria-label="{{ 'accessibility.close' | t }}">
        {% render 'icon-close' %}
      </button>
    </div>

    <div class="cart-drawer__contents">
      {% if cart == empty %}
        <div class="cart-drawer__empty">
          <p class="cart-drawer__empty-text">{{ 'sections.cart.empty' | t }}</p>
          <a href="{{ routes.all_products_collection_url }}" class="button">
            {{ 'general.continue_shopping' | t }}
          </a>
        </div>
      {% else %}
        <div class="cart-drawer__items">
          {% for item in cart.items %}
            <div class="cart-drawer__item" id="CartDrawer-Item-{{ item.index | plus: 1 }}">
              <div class="cart-drawer__item-media">
                {% if item.image %}
                  <img class="cart-drawer__item-image"
                    src="{{ item.image | image_url: width: 120 }}"
                    alt="{{ item.image.alt | escape }}"
                    loading="lazy"
                    width="120"
                    height="{{ 120 | divided_by: item.image.aspect_ratio | ceil }}"
                  >
                {% endif %}
              </div>

              <div class="cart-drawer__item-details">
                <a href="{{ item.url }}" class="cart-drawer__item-title">
                  {{ item.product.title | escape }}
                </a>

                {% unless item.original_price == item.final_price %}
                  <div class="cart-drawer__item-discounts">
                    {% for discount in item.discounts %}
                      <span class="cart-drawer__discount">
                        {% render 'icon-discount' %}
                        {{ discount.title }}
                      </span>
                    {% endfor %}
                  </div>
                {% endunless %}

                {% if item.product.has_only_default_variant == false or item.properties.size != 0 or item.selling_plan_allocation != null %}
                  <dl class="cart-drawer__item-options">
                    {% if item.product.has_only_default_variant == false %}
                      {% for option in item.options_with_values %}
                        <div class="cart-drawer__item-option">
                          <dt>{{ option.name }}:</dt>
                          <dd>{{ option.value }}</dd>
                        </div>
                      {% endfor %}
                    {% endif %}

                    {% for property in item.properties %}
                      {% assign property_first_char = property.first | slice: 0 %}
                      {% if property.last != blank and property_first_char != '_' %}
                        <div class="cart-drawer__item-option">
                          <dt>{{ property.first }}:</dt>
                          <dd>{{ property.last }}</dd>
                        </div>
                      {% endif %}
                    {% endfor %}

                    {% if item.selling_plan_allocation != null %}
                      <div class="cart-drawer__item-option">
                        <dt>{{ 'products.product.subscription.name' | t }}:</dt>
                        <dd>{{ item.selling_plan_allocation.selling_plan.name }}</dd>
                      </div>
                    {% endif %}
                  </dl>
                {% endif %}

                <div class="cart-drawer__item-pricing">
                  <div class="cart-drawer__item-price-wrapper">
                    {% if item.original_price != item.final_price %}
                      <dl class="cart-drawer__item-discounted-prices">
                        <dt class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</dt>
                        <dd class="cart-drawer__item-old-price">{{ item.original_price | money }}</dd>
                        <dt class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</dt>
                        <dd class="cart-drawer__item-new-price">{{ item.final_price | money }}</dd>
                      </dl>
                    {% else %}
                      <span class="cart-drawer__item-price">{{ item.original_price | money }}</span>
                    {% endif %}
                  </div>
                </div>

                <div class="cart-drawer__item-quantity">
                  <div class="quantity">
                    <button class="quantity__button" name="minus" type="button">
                      <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}</span>
                      {% render 'icon-minus' %}
                    </button>
                    <input class="quantity__input"
                      type="number"
                      data-quantity-variant-id="{{ item.variant.id }}"
                      data-index="{{ item.index | plus: 1 }}"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      min="0"
                      aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                      id="Drawer-quantity-{{ item.index | plus: 1 }}"
                      data-index="{{ item.index | plus: 1 }}"
                    >
                    <button class="quantity__button" name="plus" type="button">
                      <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}</span>
                      {% render 'icon-plus' %}
                    </button>
                  </div>

                  <cart-remove-button class="cart-drawer__remove" data-index="{{ item.index | plus: 1 }}">
                    <button type="button" class="button button--tertiary">
                      {{ 'sections.cart.remove' | t }}
                    </button>
                  </cart-remove-button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="cart-drawer__footer">
          <div class="cart-drawer__subtotal">
            <div class="totals">
              <h3 class="totals__subtotal">{{ 'sections.cart.subtotal' | t }}</h3>
              <p class="totals__subtotal-value">{{ cart.total_price | money_with_currency }}</p>
            </div>

            {% if cart.cart_level_discount_applications.size > 0 %}
              <ul class="cart-drawer__discounts" role="list" aria-label="{{ 'customer.order.discount' | t }}">
                {% for discount in cart.cart_level_discount_applications %}
                  <li class="cart-drawer__discount">
                    {% render 'icon-discount' %}
                    {{ discount.title }}
                    (-{{ discount.total_allocated_amount | money }})
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>

          <small class="tax-note caption-large rte">
            {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
              {{ 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
            {%- elsif cart.taxes_included -%}
              {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
            {%- elsif shop.shipping_policy.body != blank -%}
              {{ 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
            {%- else -%}
              {{ 'sections.cart.taxes_and_shipping_at_checkout' | t }}
            {%- endif -%}
          </small>

          <div class="cart-drawer__cta">
            <a href="{{ routes.cart_url }}" class="button button--outline">
              {{ 'sections.cart.view_cart' | t }}
            </a>
            <button type="submit" class="button" name="add" form="cart" 
              {% if cart == empty %}disabled{% endif %}>
              {{ 'sections.cart.checkout' | t }}
            </button>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  {% comment %} Hidden form for checkout {% endcomment %}
  <form action="{{ routes.cart_url }}" method="post" id="cart" novalidate class="cart">
    <div id="cart-errors" class="form__message"></div>
  </form>
</cart-drawer>

{% comment %} Example Product Form Usage {% endcomment %}
{% comment %}
<product-form class="product-form">
  {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
    <div class="product-form__error-message-wrapper" role="alert" hidden>
      <h3 class="form__message" tabindex="-1" autofocus>
        {% render 'icon-error' %} {{ 'templates.contact.form.error_heading' | t }}
      </h3>
      <p class="product-form__error-message"></p>
    </div>

    {%- unless product.has_only_default_variant -%}
      <div class="product-form__variants">
        {%- for option in product.options_with_values -%}
          <fieldset class="js product-form__option">
            <legend class="form__label">{{ option.name }}</legend>
            {% render 'product-variant-options', product: product, option: option, block: block %}
          </fieldset>
        {%- endfor -%}
      </div>
    {%- endunless -%}

    <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
    
    <div class="product-form__quantity">
      <label class="form__label" for="Quantity-{{ section.id }}">
        {{ 'products.product.quantity.label' | t }}
      </label>
      <div class="quantity">
        <button class="quantity__button" name="minus" type="button">
          <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: product.title | escape }}</span>
          {% render 'icon-minus' %}
        </button>
        <input class="quantity__input"
          type="number"
          id="Quantity-{{ section.id }}"
          name="quantity"
          value="1"
          min="1"
          form="{{ product_form_id }}"
        >
        <button class="quantity__button" name="plus" type="button">
          <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: product.title | escape }}</span>
          {% render 'icon-plus' %}
        </button>
      </div>
    </div>

    <div class="product-form__buttons">
      <button type="submit" name="add" 
        class="button button--outline flex items-center justify-center gap-4 product-form__cart-submit"
        {% if product.selected_or_first_available_variant.available == false %}disabled{% endif %}
        data-added-text="{{ 'products.product.add_to_cart.added' | t }}"
      >
        {% render 'cart-icon' %}
        <span>
          {%- if product.selected_or_first_available_variant.available -%}
            {{ 'products.product.add_to_cart' | t }}
          {%- else -%}
            {{ 'products.product.sold_out' | t }}
          {%- endif -%}
        </span>
      </button>
    </div>
  {%- endform -%}
</product-form>
{% endcomment %}